### Install Metasploit v5.0.0 on Linux (debian/kali)

#########################################
### Install Metasploit
#########################################
sudo apt-get install g++ postgresql ruby-dev bundler ca-certificates git libgmp-dev libpcap-dev libpq-dev libsqlite3-dev libxml2-dev libxslt-dev libffi-dev ruby-json zlib1g-dev

sudo -s
cd /opt
git clone https://github.com/rapid7/metasploit-framework/
mv metasploit-framework metasploit
cd metasploit
sudo gem install bundler

rm .*
rm -rf .git
rm -r .github

sudo ln -s /usr/include/libxml2/libxml /usr/include/libxml

bundle config build.nokogiri --use-system-libraries
bundle install --path vendor
cd ../..
ln -s /opt/metasploit/msfd /usr/local/bin/msfd
ln -s /opt/metasploit/msfrpc /usr/local/bin/msfrpc
ln -s /opt/metasploit/msfrpcd /usr/local/bin/msfrpcd
ln -s /opt/metasploit/msfupdate /usr/local/bin/msfupdate
ln -s /opt/metasploit/msfvenom /usr/local/bin/msfvenom
ln -s /opt/metasploit/Rakefile /usr/local/bin/Rakefile

cat > /usr/local/bin/msf << EOF
#!/bin/bash

# Startup PostgreSQL Database
PG_STATUS=\$(/etc/init.d/postgresql status | grep Active | awk '{print \$3}')
if [ "\$PG_STATUS" == "(dead)" ]; then
    sudo /etc/init.d/postgresql start
fi

# Initialization Database
if [ ! -f "/opt/metasploit/config/database.yml" ]; then
    sudo /usr/local/bin/msfdb init
fi

/opt/metasploit/msfconsole
EOF

chmod 755 /usr/local/bin/msf

### Configuration VNCViewer
echo '#!/usr/bin/env bash' > usr/local/bin/vncviewer
echo open vnc://\$1 >> usr/local/bin/vncviewer
chmod 755 usr/local/bin/vncviewer

### PostgreSQL Create Database & Username
wget https://raw.githubusercontent.com/Mint-Fans/linux-package/kali/msfdb
sudo chmod 755 msfdb
sudo chown 0:0 msfdb
sudo mv msfdb usr/local/bin/

### Configuration
MSFROOT=/opt/metasploit
GEMFILE=$MSFROOT/Gemfile
RUBY_VER=$(ls /usr/lib/ruby | grep [0-9])
echo "export BUNDLE_GEMFILE=$GEMFILE" >> /etc/profile
echo "export MSF_DATABASE_CONFIG=$MSFROOT/config/database.yml" >> /etc/profile
echo "export GEM_PATH=$MSFROOT/vendor/ruby/$RUBY_VER" >> /etc/profile

### Run Metasploit
sudo msfconsole

### View database connection status
> db_status
> db_rebuild_cache

### exit
> quit

#########################################
### Remove Metasploit
#########################################
sudo /usr/local/bin/msfdb delete

sudo sed -i '/metasploit/d' /etc/profile 

sudo rm /usr/local/bin/msf
sudo rm /usr/local/bin/msfconsole
sudo rm /usr/local/bin/msfd
sudo rm /usr/local/bin/msfrpc
sudo rm /usr/local/bin/msfrpcd
sudo rm /usr/local/bin/msfupdate
sudo rm /usr/local/bin/msfvenom
sudo rm /usr/local/bin/Rakefile
sudo rm /usr/local/bin/vncviewer
sudo rm /usr/local/bin/msfdb

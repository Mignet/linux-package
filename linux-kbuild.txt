### linux-kbuild

# Build Depends
sudo apt-get install libelf-dev

# Patch:
sed -i 's/$(CONFIG_BUILD_BIN2C)/y/g' scripts/basic/Makefile
sed -i 's/$(CONFIG_KALLSYMS)/y/g' scripts/Makefile
sed -i 's/$(CONFIG_LOGO)/y/g' scripts/Makefile
sed -i 's/$(CONFIG_VT)/y/g' scripts/Makefile
sed -i 's/$(BUILD_C_RECORDMCOUNT)/y/g' scripts/Makefile
sed -i 's/$(CONFIG_MODULE_SIG)/y/g' scripts/Makefile
sed -i 's/$(CONFIG_SYSTEM_TRUSTED_KEYRING)/y/g' scripts/Makefile
sed -i 's/$(CONFIG_MODVERSIONS)/y/g' scripts/Makefile
sed -i '/insert-sys-cert/a\hostprogs-y += unifdef'  scripts/Makefile

BUILD_DIR=build/linux-kbuild

# Configuration
make x86_64_defconfig
make menuconfig

# Build linux-kbuild
make scripts
make O=$BUILD_DIR scripts
make tools/objtool

# Install linux-headers
rm -rf $BUILD_DIR/arch $BUILD_DIR/include $BUILD_DIR/source $BUILD_DIR/Makefile
cp -t "${BUILD_DIR}/scripts/" scripts/*
install -Dt "${BUILD_DIR}/scripts/kconfig" -m755 scripts/kconfig/conf
install -Dt "${BUILD_DIR}/tools/objtool" -m755 tools/objtool/objtool

# Clean files
find $BUILD_DIR \( -name .*.cmd -o -name *.o \) -execdir rm {} +

##################################
### Build openssl 1.1.x for Linux
##################################
# Build Depends
sudo apt-get install m4 bc

SSLVER=1.1.1
SSLREV=f

PKGVER=${SSLVER}${SSLREV}

ARCH=amd64
PKGARCH=x86_64
ARCH_CONF="enable-ec_nistp_64_gcc_128 linux-x86_64"

ARCH=i386
PKGARCH=i386
ARCH_CONF="linux-x86"

wget --no-check-certificate https://www.openssl.org/source/openssl-${PKGVER}.tar.gz
tar zxvf openssl-${PKGVER}.tar.gz
cd openssl-${PKGVER}

# Config
./Configure \
--prefix=/usr \
--openssldir=/etc/ssl \
--libdir=lib/${PKGARCH}-linux-gnu \
shared \
$ARCH_CONF \
"-Wa,--noexecstack ${CPPFLAGS} ${CFLAGS} ${LDFLAGS}"

make depend
make -j$(nproc)

PKGDIR=$HOME/Build/openssl-${SSLVER}
make DESTDIR=$PKGDIR MANDIR=/usr/share/man install_sw install_ssldirs install_man_docs MANSUFFIX=ssl

SSLLIBDIR=$HOME/Build/libssl1.1
SSLDEVDIR=$HOME/Build/libssl-dev
mkdir -p $SSLLIBDIR/usr/lib/${PKGARCH}-linux-gnu
mkdir -p $SSLDEVDIR/usr

mv $PKGDIR/usr/lib/${PKGARCH}-linux-gnu/engines-1.1 $SSLLIBDIR/usr/lib/${PKGARCH}-linux-gnu/
mv $PKGDIR/usr/lib/${PKGARCH}-linux-gnu/libcrypto.so.1.1 $SSLLIBDIR/usr/lib/${PKGARCH}-linux-gnu/
mv $PKGDIR/usr/lib/${PKGARCH}-linux-gnu/libssl.so.1.1 $SSLLIBDIR/usr/lib/${PKGARCH}-linux-gnu/

mv $PKGDIR/usr/lib $SSLDEVDIR/usr/
mv $PKGDIR/usr/include $SSLDEVDIR/usr/

mkdir -p $PKGDIR/usr/lib
ln -sf ../../etc/ssl $PKGDIR/usr/lib/ssl

##################################
### Create DEB Package
##################################
mkdir -p $PKGDIR/DEBIAN
PKGSIZE=$(du -s $PKGDIR | awk '{print $1}')

cat > $PKGDIR/DEBIAN/control << EOF
Package: openssl
Version: ${PKGVER}-1
Architecture: $ARCH
Maintainer: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Installed-Size: $PKGSIZE
Depends: libc6, libssl1.1
Suggests: ca-certificates
Section: utils
Priority: optional
Multi-Arch: foreign
Homepage: https://www.openssl.org/
Description: Secure Sockets Layer toolkit - cryptographic utility
 This package is part of the OpenSSL project's implementation of the SSL
 and TLS cryptographic protocols for secure communication over the
 Internet.
 .
 It contains the general-purpose command line binary /usr/bin/openssl,
 useful for cryptographic operations such as:
  * creating RSA, DH, and DSA key parameters;
  * creating X.509 certificates, CSRs, and CRLs;
  * calculating message digests;
  * encrypting and decrypting with ciphers;
  * testing SSL/TLS clients and servers;
  * handling S/MIME signed or encrypted mail.
Original-Maintainer: Debian OpenSSL Team <pkg-openssl-devel@lists.alioth.debian.org>
EOF

cat > $PKGDIR/DEBIAN/conffiles << EOF
/etc/ssl/openssl.cnf
EOF

mkdir -p $SSLLIBDIR/DEBIAN
PKGSIZE=$(du -s $SSLLIBDIR | awk '{print $1}')

cat > $SSLLIBDIR/DEBIAN/control << EOF
Package: libssl1.1
Source: openssl
Version: ${PKGVER}-1
Architecture: $ARCH
Maintainer: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Installed-Size: $PKGSIZE
Depends: libc6, debconf | debconf-2.0
Section: libs
Priority: optional
Multi-Arch: same
Homepage: https://www.openssl.org/
Description: Secure Sockets Layer toolkit - shared libraries
 This package is part of the OpenSSL project's implementation of the SSL
 and TLS cryptographic protocols for secure communication over the
 Internet.
 .
 It provides the libssl and libcrypto shared libraries.
Original-Maintainer: Debian OpenSSL Team <pkg-openssl-devel@lists.alioth.debian.org>
EOF

cat > $SSLLIBDIR/DEBIAN/postinst << EOF
#!/bin/sh
set -e

ldconfig

EOF

mkdir -p $SSLDEVDIR/DEBIAN
PKGSIZE=$(du -s $SSLDEVDIR | awk '{print $1}')

cat > $SSLDEVDIR/DEBIAN/control << EOF
Package: libssl-dev
Source: openssl
Version: ${PKGVER}-1
Architecture: $ARCH
Maintainer: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Installed-Size: $PKGSIZE
Depends: libssl1.1
Section: libdevel
Priority: optional
Multi-Arch: same
Homepage: https://www.openssl.org/
Description: Secure Sockets Layer toolkit - development files
 This package is part of the OpenSSL project's implementation of the SSL
 and TLS cryptographic protocols for secure communication over the
 Internet.
 .
 It contains development libraries, header files, and manpages for libssl
 and libcrypto.
Original-Maintainer: Debian OpenSSL Team <pkg-openssl-devel@lists.alioth.debian.org>
EOF

chmod 755 $SSLLIBDIR/DEBIAN/postinst
sudo chown -R 0:0 $PKGDIR $SSLLIBDIR $SSLDEVDIR

cd $HOME/Build
sudo dpkg -b openssl-${SSLVER} openssl_${PKGVER}-1_${ARCH}.deb
sudo dpkg -b libssl1.1 libssl1.1_${PKGVER}-1_${ARCH}.deb
sudo dpkg -b libssl-dev libssl-dev_${PKGVER}-1_${ARCH}.deb

